---
layout: post
title: B树与B+树
date: 2022-09-06
tags: [mysql]
---

#### B树(平衡树)结构图
![B树结构图](/images/B-Tree.png)

#### B树结构与特性
- m阶B树上限：子节点数 <= m，每个节点元素个数 = m - 1；类似二叉树（最多有两个子节点，每个节点最多有1个元素）。比如5阶B树，非叶节点左右有5个子节点，每个节点中的元素最多有4个
- m阶B树下限：根节点（子节点数 >= 2，元素数量 >= 1）；其他节点（子节点数 >= m/2向上取整， 元素个数 >= m/2向上取整 -1））。比如5阶B树，根节点最少有2个子节点，且根节点最少有1个元素；其他节点最少有3个子节点，每个节点最少有2个元素
- 平衡性：所有的叶子节点都在同一层
- 有序性：节点内的元素顺序是排序的，且任一元素的左子树的所有元素都小于它，右子树的元素都大于它
- 多路性：每个非叶节点可以有多个子节点，根树的阶树有关
- 每个节点都会存储整个数据

#### B+树的结构与特性
- B+树每个节点元素数量上限由B树的 m - 1 提升为m，下限由(m/2向上取整 - 1) 提升为 m/2向上取整
- 叶子节点有序存储了所有数据（包含非叶节点键值对应的数据），非叶节点只存储键值（如主键ID）
- 叶子字节元素通过单向链表进行连接，而且元素是顺序排序的

#### B+树结构图
![B+树结构图](/images/B+tree.png)

#### B树与B+树的区别
1. 每个节点存储元素数量的上限与下限不同，B树（上限：m-1, 下限：m/2向上取整 - 1），B+树（上限：m， 下限：m/2向上取整）
2. B树叶子节点与非叶子节点都会存储键值及数据； B+树只有叶子节点会存储键值及数据（顺序排序），非叶子节点只存储键值
3. 在数据库中页的大小是固定的，InnoDB中页默认大小为16k
4. B+树非叶子节点不存储数据，意味着每个节点能够存储更多的键值，树就会变得更矮更胖，查询数据时磁盘IO次数更少
5. B树所有节点都会存储数据，每个节点存储的键值减少，树会变得更高，查询时需要从磁盘中读取更多的页节点
6. B+树的叶子节点中的数据是单向链表进行连接的，并且是有序的，对于范围查找更高效，不用每次都从根节点遍历

#### 一个三层的B+树主键索引最大能存多少行数据
1. mysql中每个节点是一页，每页能存16kb数据
2. 根节点只有1个节点能存16kb，子节点数 = 16 * 1024 / （4 + 6）= 1638，根节点最能有1638个子节点，4为主键ID占用的字节数，6为根节点指向下一个节点的指针占用的字节数
3. 树的第二层最多能够存储1638个节点，每个节点最多同样最多能有1638个子节点。因此第二层能够指向1638 * 1638 个子节点
4. 树的叶子节点存储每一行的所有字段数据，假设每行数据占用1kb，因此叶子节点每页能够存储数据行数 = 16k / 1k = 16, 那么叶子存储的最大数据行数= 16 * 1638 * 1638 = 268435456， 前提是每页数据占用1kb


