---
layout: post
title: MySQL行级锁
date: 2018-03-21
tags: [SQL]
description: 深入了解MySQL行级共享、排它锁。
---

**描述**
> 行级锁是mysql中锁定粒度最细的一种锁，行级锁能够大大减少数据库操作的冲突，同时也会影响并发量。

**共享锁(share lock)**
> 共享锁又称读锁，是读取操作创建的锁，其他事物可以并发读取数据，但是任何事物都不能对该数据进行修改，直到已释放所有的共享锁；
>如果事物T对数据A加上了共享锁后，则其他事物只能对数据A再加共享锁，不能加排他锁，获准共享锁的事物只能读数据，不能修改数据。

用法：
```mysql
SELECT ... LOCK IN SHARE MODE;
```
在查询语句中增加LOCK INSHARE MODE，mysql会对查询结果中的每行都加共享锁，当没有其他线程对查询结果集中的任何一行使用排他锁时，可以成功申请共享锁，否则会被阻塞。

**排它锁(exclusion lock)**
> 排它锁也成写锁，如果事物T对数据A加上排它锁，则其他事物不能对数据A加任何类型的锁，获准排它锁的事物既能修改数据也能读数据，其他事物对该数据有读权限

用法：
```mysql
SELECT ... FOR UPDATE;
```
在查询语句后面增加FOR UPDATE，Mysql会对查询结果中的每行都加排他锁，当没有其他线程对查询结果集中的任何一行使用排他锁时，可以成功申请排他锁，否则会被阻塞。

**其他问题**
1. 对于insert, update, delete,InnoDB会自动给涉及到的数据加排它锁，对于select语句，InnoDB不会主动加任何锁。
2. 行级锁都是基于索引的，如果一条sql中用不到索引是不会使用行级锁的，会使用表级锁把整张锁住。 

