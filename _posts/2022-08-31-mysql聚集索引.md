---
layout: post
title: mysql聚集索引
date: 2022-08-31
tags: [mysql]
---

#### 聚集索引与非聚集索引结构图
![聚集索引与普通索引结构图](/images/cluster-index.png)

#### 什么是聚集索引
1. mysql只有innodb引擎有聚集索引，且每张表的聚集索引有且只有一个，聚集索引键值按照一定规则顺序排序
2. 默认以主键索引作为聚集索引，否则系统会尝试选择一个Not Null的唯一键索引作为聚集索引；如果不存在这样的唯一索引，InnoDB会自动创建一个6字节长的隐藏字段作为聚集索引
3. 聚集索引在B+树的表现为：B+树非叶子节点存储键值，B+树的叶子节点存储键值及表中的数据。

#### 什么是非聚集索引
1. 主键索引以外的其他索引都是非聚集索引，比如联合索引、普通索引等。每张表的非聚集索引可以有多个。
2. 非聚集索引区别与聚集索引：非聚集索引B+树的叶子节点存储的是该行对应的主键，而不是表中的数据
3. 在使用非聚集索引查数据时，首先需要在非聚集索引对应的B+树中找到对应的主键，然后回表操作通过主键获取到聚集索引叶子节点的数据

#### 通过聚集索引查找数据
![聚集索引查找数据过程](/images/B+tree.png)
- 以下是聚集索引的B+树索引图，叶子节点存储键值及表中的数据
-  假设现在要查找id在[18, 40)内的数据， 查找过程如下：
1. 一般B+树中的根节点都是常驻内存，也就是说页1存在内存中，不需要从磁盘中读取，直接从内存中读取即可。
2. 首先需要找到id=18的键值，在页1中我们可以发现键值为18对应的指针为p2。
3. 然后通过指针p2从定位到页3，然后从磁盘中读取页3并放入内存中
4. 此时发现键值为18在页3中的指针为p1，然后通过页3的指针p1定位到页8，从磁盘中读取页8并放入内存中
5. 此时发现页8的数据是链表结构，且是叶子节点，键值是按照顺序排序的。此时可以通过二分查找定位到键值18
6. 因为是范围查找，此时我们遍历此页链表中键值id>=18 and id<40的元素，该叶子节点符合条件的数据有(18,kl), (19,kl), (22,hj)
7. 该页遍历完还没查找完需要的数据（键值为40），此时拿到该页的指针定位到下一页，即页9，查找到符合条件的数据有：(24,io), (25,vg) , (29,jk)
8. 同理，页9遍历完还没找到键值 >= 40的，拿到页9的指针定位到页10，查找到符合条件的数据有： (31,jk) , (33,rt) , (34,ty) 
9. 页11查找到符合条件的数据：(35,yu) , (37,rt) , (39,rt) ，此时仍未找到键值为40的数据，继续通过页10的指针定位到页11
10. 此时发现页11链表的第一个元素的键值为41， 大于需要查找的主键值40，查询结束。

#### 有序主键与无序主键区别
- 有序主键插入/更新效率更高
    > 原因是B+树是按键值顺序存储的，当主键有序时，可以直接将数据追加到当前B+树最后一个数据页。
    > 反之主键无序时，为保证索引树的有序性，会涉及到索引树的拆分合并过程。
- 二级索引查找（按主键精确查找不影响）
    > 原因是二级索引查找时，需要先通过非聚集索引查询出主键，此时查询出的主键是无序的，可能会导致回表查询IO次数变多

#### mysql索引字段长度
> 在数据库设计时，索引字段长度尽量小，因为B+树的每页大小是固定的，默认为16kb，
> 若索引字段占用字节数过多，会导致每页能够存储的键值数量变少，从而导致整个树变高，查询时磁盘访问次数变多，从而导致性能下降

#### 三层B+树能够存储多少数据
> B+树每页16kb， 每个键值都包含一个指针，指针占用6字节；假设键字段长度为int类型，占用4个字节，
> 第一层（根结点）每页能存储的键值数为 = 16 * 1024b / (6b + 4b) = 1638，
> 第二层（非叶子结点）每页能存储的键值数量为 = 1638 * 1638 = 2683044
> 第三层（叶子结点），假设数据库中每行数据大小为1kb，那么叶子结点能够存储的数据为 = 2683044 * 16kb / 1kb = 42928704

#### B+树叶子结点之间为何使用双向链表连接
1. 范围查询时效率更高：假设要查询id在[100,110]区间的数据，会先找到100的叶子结点，然后通过右指针遍历100之后的数据
2. 逆向范围查询时效率更高：order by id desc，会先找到最大的id，然后通过左指针逆向遍历该id之前的数据
3. 全表扫描效率更高：全表扫描会走聚集索引，从左到右顺序遍历叶子结点
