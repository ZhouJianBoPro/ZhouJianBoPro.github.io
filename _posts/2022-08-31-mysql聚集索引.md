---
layout: post
title: mysql聚集索引
date: 2022-08-31
tags: [mysql]
---

#### 聚集索引与非聚集索引结构图
![聚集索引与普通索引结构图](/images/cluster-index.png)

#### 什么是聚集索引
1. mysql只有innodb引擎有聚集索引，且每张表的聚集索引有且只有一个，聚集索引键值按照一定规则顺序排序
2. 默认以主键索引作为聚集索引，否则系统会尝试选择一个Not Null的唯一键索引作为聚集索引；如果不存在这样的唯一索引，InnoDB会自动创建一个6字节长的隐藏字段作为聚集索引
3. 聚集索引在B+树的表现为：B+树非叶子节点存储键值，B+树的叶子节点存储键值及表中的数据。

#### 什么是非聚集索引
1. 主键索引以外的其他索引都是非聚集索引，比如联合索引、普通索引等。每张表的非聚集索引可以有多个。
2. 非聚集索引区别与聚集索引：非聚集索引B+树的叶子节点存储的是该行对应的主键，而不是表中的数据
3. 在使用非聚集索引查数据时，首先需要在非聚集索引对应的B+树中找到对应的主键，然后回表操作通过主键获取到聚集索引叶子节点的数据

#### 通过聚集索引查找数据
![聚集索引查找数据过程](/images/B+tree.png)
- 以下是聚集索引的B+树索引图，叶子节点存储键值及表中的数据
-  假设现在要查找id在[18, 40)内的数据， 查找过程如下：
1. 一般B+树中的根节点都是常驻内存，也就是说页1存在内存中，不需要从磁盘中读取，直接从内存中读取即可。
2. 首先需要找到id=18的键值，在页1中我们可以发现键值为18对应的指针为p2。
3. 然后通过指针p2从定位到页3，然后从磁盘中读取页3并放入内存中
4. 此时发现键值为18在页3中的指针为p1，然后通过页3的指针p1定位到页8，从磁盘中读取页8并放入内存中
5. 此时发现页8的数据是链表结构，且是叶子节点，键值是按照顺序排序的。此时可以通过二分查找定位到键值18
6. 因为是范围查找，此时我们遍历此页链表中键值id>=18 and id<40的元素，该叶子节点符合条件的数据有(18,kl), (19,kl), (22,hj)
7. 该页遍历完还没查找完需要的数据（键值为40），此时拿到该页的指针定位到下一页，即页9，查找到符合条件的数据有：(24,io), (25,vg) , (29,jk)
8. 同理，页9遍历完还没找到键值 >= 40的，拿到页9的指针定位到页10，查找到符合条件的数据有： (31,jk) , (33,rt) , (34,ty) 
9. 页11查找到符合条件的数据：(35,yu) , (37,rt) , (39,rt) ，此时仍未找到键值为40的数据，继续通过页10的指针定位到页11
10. 此时发现页11链表的第一个元素的键值为41， 大于需要查找的主键值40，查询结束。

