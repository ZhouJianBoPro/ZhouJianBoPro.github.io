---
layout: post
title: 分布式事务实现方案
date: 2025-05-26
tags: [concurrency]
---

#### 二阶段提交（2PC）
> 2PC在正常情况下可以保证数据强一致性，适用于读写一致性要求高的场景

##### 核心角色
- 事务协调者（Coordinator）：负责启动一个全局事务，并向所有事务参与者发送事务执行指令
- 事务参与者（Participant）：事务的实际执行者，通常是不同的数据库或服务

##### 执行流程
- 准备提交阶段（PreCommit）
  1. 事务协调者向所有事务参与者发送prepare准备指令，询问是否可以执行
  2. 事务参与者执行事务但不提交，并锁定相关资源
  3. 事务协调者收到参与者的ack确认
- 提交/回滚阶段（DoCommit）
  1. 当所有事务参与者ack成功时，协调者向所有参与者发送commit提交事务指令，参与者提交事务并释放资源，并返回ack确认
  2. 当任一事务参与者ack成功时，协调者向所有参与者发送rollback回滚事务指令，参与者rollback事务后释放所资源并返回ack确认
  3. 当所有参与者都返回ack确认时，事务协调者终止事务。否则协调者会有重试机制

##### 2PC局限性
1. 资源阻塞：在第一阶段就进行了资源锁定，直到事务提交或回滚后才会释放资源
2. 协调者故障：无法向事务参与者发送指令，导致整个事务流程阻塞
3. 部分参与者单点故障（数据强一致性问题）：若部分参与者收到commit/rollback指令，可能会在短时间内造成数据一致性的问题（事务协调者通过重试等机制实现数据最终一致性）


#### 三阶段提交（3PC）
> 3PC由于减少了资源阻塞时间，并且引入了超时处理机制，可以极大提升系统并发能力

##### 执行流程
- 能否提交阶段（CanCommit）
  1. 协调者向所有参与者发送canCommit指令，用于询问当前节点是否健康可用，降低后续阶段失败的概率（此时不会执行事务操作）
  2. 当所有参与者都返回YES时，协调者发送PreCommit指令。否则协调者界定终止事务
- 准备提交阶段（PreCommit）
- 提交/回滚阶段（DoCommit）

##### 3PC优势与缺点
1. 通过引入CanCommit阶段可以询问参与者节点是否健康可用，从而降低后续阶段失败概率
2. 引入了超时处理机制，当协调者单点故障时，参与者可以通过超时机制自行决定提交或回滚事务，避免无限阻塞，提升系统可用性
3. 性能开销：3PC相比2PC需要多一次网络通信，增加了通信成本

#### TCC（Try-Confirm-Cancel）
> TCC是一种补偿型的分布式事务机制，可用于保证事务最终一致性

##### 执行流程
- 尝试阶段（Try）
  1. 协调者向所有参与者发送Try指令，用于参与者尝试执行业务，完成业务检查并预留相关资源
  2. 参与者返回ack确认
  3. 当任一参与者未返回ack确认成功时，协调者会发送Cancel指令用于取消所有业务
  4. 如用户下单操作，先保存预订单，校验库存并锁定库存。当库存不足时，此时协调者会发送Cancel执行取消业务
- 确认阶段（Confirm）
  1. 当所有参与者Try ack成功时，协调者向所有参与者发送Confirm命令（该阶段会认为业务一定能成功）
  2. 执行业务，使用Try阶段预留的资源真正提交事务
  3. 当某个节点确认失败时，可以通过定时补偿机制进行重试确认，因此业务一定要做幂等处理
  4. 正常情况下如修改预订单状态为订单完成，扣减商品库存。当扣减库存失败时，更新事务状态，然后通过补偿机制进行重试
- 取消阶段（Cancel）
  1. 回滚业务，在任一节点执行Try失败或异常时，协调者会向所有参与者发送Cancel指令，用于回滚所有业务
  2. 任一节点取消失败时，更新事务状态，然后通过定时补偿机制进行重试

##### 关键特性
- 幂等性：Confirm和Cancel必须要支持业务幂等，防止补偿机制重复执行业务
- 最终一致性：TCC不能保证强一致性，可以通过补偿任务实现最终一致性
- 对业务侵入性强：需要手动实现Try，Confirm，Cancel业务逻辑
- 事务日志：持久化记录事务状态，用于恢复和补偿
- 补偿机制：通过定时补偿机制，对未完成的事务进行补偿处理





