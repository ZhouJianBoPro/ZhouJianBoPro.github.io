---
layout: post
title: RocketMQ消息堆积
date: 2022-08-29
tags: [rocketmq]
---

#### 消息堆积原因
> RocketMQ中消息堆积根本原因是生产速度 > 消费速度。常见的原因包括：
> 消费者性能瓶颈、消费者消费异常多次重试后进入私信队列（默认16次）、突发流量、消费者宕机等

#### 什么是死信队列
> 死信队列（%DLQ%<ConsumerGroupName>）用于存储消费失败的消息，当消息消费失败达到一定次数（默认16次）时，消息会进入死信队列。
> 建议对死信队列进行监听并发送告警、便于人员及时介入

#### 提升消费者的消费能力
> 从业务代码逻辑上优化/修复消费者的消费逻辑，比如优化数据查询效率

#### 消费者扩容
> RocketMQ消费端的负载均衡策略（默认为平均分配算法），Consumer可以均匀分配到多个MessageQueue进行消费。
> 因此，当Topic中的MessageQueue数量配置够多时，可以通过对消费者扩容方式提升消费能力

#### 消息转储
> 当Topic中MessageQueue配置较少时，此时不能依靠消费者扩容提升消费能力（一个MessageQueue只会被一个消费者消费）。
> 但是可以通过 消息转储 + 新消费者扩容 方式变相实现：
> 首先可以新建一个临时Topic，配置足够多的MessageQueue，并新建一组订阅该Topic的临时消费者，消费逻辑同原消费者；
> 原消费者不再处理业务逻辑，监听到消息后将消息转发到新的Topic下。
> 待堆积消息处理完毕后，可以逐步下线临时Topic和消费者，并恢复原消费者处理逻辑
