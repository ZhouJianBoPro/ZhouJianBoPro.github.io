---
layout: post
title: redis部署方案
date: 2025-02-14
tags: [redis]
---

#### 单机部署
应用于小型应用，特点是简单易用，部署成本小。无高可用性，单点故障高

#### 主从复制架构（Master-Slave）
- 一主多从：通常是一个主节点和多个从节点
- 读写分离：主节点负责写操作，从节点提供读操作
- 异步复制：保证主从节点的数据一致性
- 故障恢复：在主节点发生故障时，可以手动将其中一个从节点切换为主节点
- 扩展性：主从复制架构可以通过扩展从节点，以提高系统的性能
- 应用场景：一主多从架构适用于读多写少的应用场景

##### 异步复制
- 初始化同步（全量复制）：从节点与主节点建立连接后，从节点会向主节点发送PSYNC命令，主节点会返回RDB文件（全量数据快照），从节点加载RDB文件并重建数据集
- 增量复制：一旦从节点加载完RDB文件后，主从架构进入增量复制过程。在这个阶段，所有的写操作在主节点执行后，都会被记录到AOF文件中，并实时通知给所有的从节点，从节点应用这些更改以保证同主节点的数据一致性

#### 哨兵模式（Sentinel）
- 故障检测：哨兵节点会持续监控主从节点的健康状况
- 故障转移：当主节点异常时，哨兵节点会选举出新的主节点
- 故障恢复：当异常主节点恢复正常后，它会被降级为从节点，继续接受新主节点同步过来的数据
- 配置管理：哨兵节点维护主从节点的配置关系，客户端通过哨兵获取主从节点地址
- 高可用性：可以通过设置多个哨兵节点实现高可用性
- 应用场景：哨兵模式可以应用在高可用系统中，它可以自动检测出主从节点的健康状况并自动选举出新的主节点，同时在节点异常时可以通过发送邮件等方式通知运维人员

##### 故障检测
- 心跳检测：哨兵节点会定期的向主从节点发送ping命令，以检测它们是否响应
- 超时判断：如果某个主从节点在配置的时间内没有响应ping命令，则该节点会被标注为下线
- 配置参数：down-after-milliseconds 定义了哨兵节点认为节点不可达的时间阈值

##### 故障转移
- 选举新的主节点：哨兵节点会选择一个合适的从节点作为新的主节点，优选选择与就节点同步最新的从节点；有限选择网络延迟较低且性能较好的节点

#### 集群模式
- 数据分片：redis将集群空间分成16384个哈希槽，每个键通过CRC16算法计算键的哈希值，然后取模16384得到对应的哈希槽编号；redis集群会将16384个哈希槽均匀分配给各个节点，确保每个哈希槽有一个明确的归属
- 高可用性：redis支持主从复制，主节点故障时，从节点自动接替
- 最少节点配置：redis集群最少需要3个主节点和3个从节点；原因1是需要保证数据分片存储，原因2是节点故障转移需要半数以上节点同意。每个主节点最少需要一个从节点。
- 使用场景：大规模数据存储和并发场景

#### 持久化配置
- RDB：定期全量数据快照文件，适合备份和灾难恢复，save 300 10（5分钟内有10个写操作触发数据快照）
- AOF：增量写操作数据文件，记录每个写操作，appendonly yes