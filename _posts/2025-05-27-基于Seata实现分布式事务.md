---
layout: post
title: 基于Seata实现分布式事务
date: 2025-05-27
tags: [concurrency]
---

#### 核心组件
- TC（事务协调者）
  1. 负责全局事务的创建、提交、回滚
  2. 管理所有的RM分支事务，并协调它们完成提交或回滚
  3. 持久化事务日志（如xid，branchId，状态等）
  4. 事务补偿机制，支持重试提交或回滚未完成的事务
- TM（事务管理器）
  1. TM是全局事务的起点，通过@GlobalTransactional注解开启全局事务
  2. TM向TC注册一个新的全局事务，TC返回xid（全局事务ID）
  3. 所有RM执行本地事务后，TM决定是否向TC发起全局提交或回滚
- RM（事务参与者）
  1. 使用xid注册分支事务到TC
  2. 执行本地事务
  3. 生成undo_log用于事务回滚
  4. 提交本地事务并通知TC分支事务的状态

#### 四种模式
- XA模式：基于2PC两段提交，强一致性事务，牺牲了可用性，无业务侵入
- AT模式：最终一致性的分布式事务，Seata默认的模式，无业务侵入
- TCC模式：最终一致性事务，有业务侵入
- SAGA模式：基于补偿机制，最终一致性事务，有业务侵入

#### AT模式
> AT模式是一种无侵入的分布式事务解决方案，它通过对业务代码的零侵入，自动拦截并管理分布式事务，使得开发者可以像使用本地事务一样使用分布式事务

##### AT模式核心原理
- 准备阶段：本地事务提交 + 快照记录
  1. TM发起全局事务（ @GlobalTransactional），向TC注册全局事务，并返回全局事务xid
  2. RM使用DataSourceProxy拦截并解析SQL，获取表结构和主键ID，然后查询当前主键ID对应的数据库记录，生成事务前（before image）的数据快照
  3. RM执行SQL，修改数据库（暂时不提交本地事务），然后获取事务后（after image）的数据快照
  4. before/after image写入到undo_log（一条记录）表中，并跟随本地事务一起提交
  5. RM使用xid向TC注册分支事务
- 提交阶段：全局提交或回滚事务
  1. 全局提交：TC收到所有RM成功注册分支事务后，会通知所有的RM删除undo_log中的数据快照
  2. 全局回滚：当任意RM失败，TC会通知所有的RM根据undo_log进行回滚数据。after image用于校验当前数据是否被其他事务修改过，如果校验通过，则用before image还原数据

##### undo_log表接口
1. 表结构
    ```sql
    CREATE TABLE `undo_log` (
      `id` BIGINT(20) NOT NULL AUTO_INCREMENT,
      `branch_id` BIGINT(20) NOT NULL COMMENT '分支事务ID',
      `xid` VARCHAR(100) NOT NULL COMMENT '全局事务ID',
      `context` VARCHAR(255) NOT NULL COMMENT '扩展字段（如编码）',
      `rollback_info` LONGBLOB NOT NULL COMMENT '快照内容（before/after image）',
      `log_status` INT(11) NOT NULL COMMENT '日志状态：1=正常，2=提交，3=回滚中，4=已完成',
      `log_created` DATETIME NOT NULL COMMENT '创建时间',
      `log_modified` DATETIME NOT NULL COMMENT '最后修改时间',
      PRIMARY KEY (`id`),
      UNIQUE KEY `ux_undo_log` (`xid`, `branch_id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
    ```
2. rollback_info内容解析
    ```json
    {
      "sqlType": "UPDATE",
      "tableName": "inventory",
      "beforeImage": [
        {
          "product_id": 1001,
          "stock": 10
        }
      ],
      "afterImage": [
        {
          "product_id": 1001,
          "stock": 9
        }
      ]
    }
    ```



