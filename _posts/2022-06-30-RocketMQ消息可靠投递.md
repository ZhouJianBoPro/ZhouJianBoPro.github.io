---
layout: post
title: RocketMQ消息可靠投递
date: 2022-06-30
tags: [rocketmq]
---

#### RocketMQ架构图
![RocketMQ架构图](/images/rocketmq.png)

#### 消息发送阶段
> 消息发送时由于网络异常等原因导致消息发送失败，可以通过设置消息重试次数或持久化消息后进行补偿发送；
> 发送单向消息，不关心消息发送结果，有可能也会导致消息丢失。针对这种情况，建议使用同步发送消息

#### 消息存储阶段（异步刷盘）
> Broker刷盘策略默认为异步刷盘，Master收到生产者发送的消息时，先写入PageCache（内存缓存）, 写入成功即向生产者返回SEND_OK。
> 然后通过异步线程将缓存写入磁盘中的commitlog中。若在异步写入磁盘时Broker节点宕机，会导致消息丢失。

#### 主从同步阶段（异步复制）
> Broker主从同步方式默认为异步复制，当Master节点在Slave节点完成数据同步前宕机：
> 1.Master发生磁盘损坏或文件丢失会导致消息丢失，Slave没办法同步到丢失的消息；
> 2.Master恢复服务且文件完整时，Slave节点仍能继续同步Master消息

#### 消息消费阶段
> 消费者在监听到消息并完成业务处理后返回CONSUME_SUCCESS，消费者会自动提交消费偏移量。 Broker会根据消费偏移量标记该消息已消费，不会推送给其他消费者。
> 若在返回CONSUME_SUCCESS之前消费者宕机，或提交偏移量时Broker宕机时，会导致该消息没有标记为已消费。
> 因此需要保证消息消费的幂等性，支持消息的可重复消费
